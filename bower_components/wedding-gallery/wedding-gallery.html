<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">

<dom-module id="wedding-gallery" >
<style>
    .modal {
      display: none;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.9) none repeat scroll 0 0;
      overflow: hidden;
      position: fixed;
      z-index: 999999;
      top:0;
      left: 0;
    }    
    
    .modal-header {
      border-bottom: 1px solid #e5e5e5;
      min-height: 16.43px;
      padding: 5px;
      background: #fff;
    }
    
    button.close {
      background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
      border: 0 none;
      cursor: pointer;
      padding: 10px;
      float: right;
    }
    
    .modal-body {
      cursor: pointer;
      overflow: hidden;
      position: relative;
      text-align: center;
      @apply(--layout-flex);
    }
    
    .modal-content {
      width: 100%;
      height: 100%;
      padding: 2%;
      box-sizing: border-box;
      @apply(--layout-vertical);
    }
        
    .modal-img {
      position: absolute;
      height: 100%;
      left: 50%;
      transform: translate(-50%, 0);
      /* http://stackoverflow.com/questions/1776915/how-to-center-absolute-element-in-div#answer-23384995 */
    }
    
    .btn-default {
      background-color: #fff;
      border-color: #ccc;
      color: #333;
      border: 1px solid #6d6969;
      padding: 5px;
    }
    
    #previous {
      float: left;
    }
    
    #next {
      float: right;
    }

    #links a {
      display: block;
      float: left;
    }

    .modal-footer {
      float: left;
      width: 96%;
      background: #fff none repeat scroll 0 0;
      padding: 10px 2%;
    }
    
</style>
  <script>
    HTMLImports.whenReady(function () {
        (function() {
            var current_index = 0;
            var image_length = 0;

            Polymer({
                is: "wedding-gallery",
                properties: {
                  boundKeys: {
                    type: String,
                    readOnly: true,
                    value: "esc left right"
                  },
                  target: {
                    type: Object,
                    value: function() {
                      return document.body;
                    }
                  }
                },
                ready: function() {
                  var images = Polymer.dom(this).querySelectorAll('img');
                  var container = this.$.links;

                  for (var imageIndex in images) {
                    var img = images[imageIndex];
                    img.addEventListener('click', this.load_popup.bind(this));
                    container.appendChild(images[imageIndex]);
                  }
                },
                load_popup: function(e, detail, sender) {
                  e.preventDefault();
                  var links = document.getElementById('links');
                  image_length = links.getElementsByTagName('img').length;

                  var image_url = e.target.getAttribute('data-original');
                  var modal_body = document.getElementsByClassName("modal-body")[0];
                  var modal_img = modal_body.getElementsByTagName('img')[0];
                  modal_img.setAttribute("src", image_url);
                  var modal = document.getElementsByClassName("modal")[0];
                  modal.style.display = 'block';

                  current_index = parseInt(e.target.getAttribute('data-index').replace("s", ""));

                  // Add a target to the key listener when the popup loads.
                  this.$.keylistener.target = document.body;

                  return false;
                },
                next: function() {
                  current_index = current_index + 1;
                  if(current_index == (image_length + 1) ) {
                    current_index = 1;
                  }
                  var current_image = document.querySelectorAll("[data-index='s" + current_index + "']");
                  image_url = current_image[0].getAttribute('data-original');
                  var modal_body = document.getElementsByClassName("modal-body")[0];
                  var modal_img = modal_body.getElementsByTagName('img')[0];
                  modal_img.setAttribute("src", image_url);
                },
                prev: function() {
                  current_index = current_index - 1;
                  if(current_index == 0 ){
                    current_index = image_length;
                  }
                  var current_image = document.querySelectorAll("[data-index='s" + current_index + "']");
                  image_url = current_image[0].getAttribute('data-original');
                  var modalbody = document.getElementsByClassName("modal-body")[0];
                  var modal_img = modalbody.getElementsByTagName('img')[0];
                  modal_img.setAttribute("src", image_url);
                },
                close: function () {
                  var modal = document.getElementsByClassName("modal")[0];
                  modal.style.display = "none";

                  // Remove the key listener on the body. Must set to some node.
                  this.$.keylistener.target = this.$.keylistener;
                },
                keypressed: function(event, detail) {
                  console.log(detail.keyboardEvent.keyCode);
                  switch(detail.keyboardEvent.keyCode) {
                    case 27: // ESC
                      this.close();
                      break;
                    case 37: // Left
                      this.prev();
                      break;
                    case 39: // Right
                      this.next();
                      break;
                  }
                },
            });
        })();
            
    });
  </script>
    
  <template>
    <div id="gallery-panel" class="gallery-panel">
      <!-- The container for the modal slides -->
      <div id="slides" class="slides">
          <div id="links" name="links"></div>
      </div>

      <!-- The modal dialog, which will be used to wrap the lightbox content -->
      <iron-a11y-keys id="keylistener" keys="[[boundKeys]]" on-keys-pressed="keypressed">
      <div id="modalOverlay" class="modal fade" on-click="next">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" aria-hidden="true" on-click="close" >X</button>
          </div>
          <div class="modal-body">
            <img class="modal-img"/>
          </div>
          <div class="modal-footer">
            <button id="previous" type="button" class="btn btn-default pull-left prev" on-click="prev">Previous</button>
            <button id="next" type="button" class="btn btn-default next" on-click="next">Next</button>
          </div>
        </div>
      </div>
    </div> 
  </template>
</dom-module>
